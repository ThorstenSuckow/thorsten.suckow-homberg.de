"use strict";(self.webpackChunkthorsten_suckow_homberg_de=self.webpackChunkthorsten_suckow_homberg_de||[]).push([[3438],{1453:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,bibRefs:()=>c,contentTitle:()=>d,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>h});const s=JSON.parse('{"id":"wiki/linux.drivertypes","title":"System Driver Types","description":"User Space Driver","source":"@site/docs/wiki/linux.drivertypes.mdx","sourceDirName":"wiki","slug":"/wiki/linux.drivertypes","permalink":"/docs/wiki/linux.drivertypes","draft":false,"unlisted":false,"editUrl":"https://github.com/thorstensuckow/thorsten.suckow-homberg.de/tree/main/docs/wiki/linux.drivertypes.mdx","tags":[],"version":"current","lastUpdatedBy":"Thorsten Suckow-Homberg","lastUpdatedAt":1756846844000,"frontMatter":{"title":"System Driver Types"},"sidebar":"wiki","previous":{"title":"Domain Model","permalink":"/docs/wiki/ddd.domainmodel"},"next":{"title":"Entity","permalink":"/docs/wiki/softwaredesign.entity"}}');var i=r(4848),t=r(8453),o=(r(5142),r(3271));const l={title:"System Driver Types"},d="System Driver Types (Linux)",a={},c=["KR88"],h=[{value:"User Space Driver",id:"user-space-driver",level:2},{value:"Kernel Space Driver",id:"kernel-space-driver",level:2},{value:"<code>insmod</code> / <code>rmmod</code>",id:"insmod--rmmod",level:3},{value:"<code>init_module</code> / <code>cleanup_module</code>",id:"init_module--cleanup_module",level:3}];function m(e){const n={a:"a",annotation:"annotation",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",math:"math",mo:"mo",mrow:"mrow",ol:"ol",p:"p",pre:"pre",section:"section",semantics:"semantics",span:"span",strong:"strong",sup:"sup",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"system-driver-types-linux",children:"System Driver Types (Linux)"})}),"\n",(0,i.jsx)(n.h2,{id:"user-space-driver",children:"User Space Driver"}),"\n",(0,i.jsxs)(n.p,{children:["When full access to a device's resources is not required, a ",(0,i.jsx)(n.strong,{children:"User Space Driver"})," (",(0,i.jsx)(n.em,{children:"USD"}),") can utilize system interfaces for limited access to the device's memory space and handling interrupts",(0,i.jsx)(n.sup,{children:(0,i.jsx)(n.a,{href:"#user-content-fn-kernel-user-space",id:"user-content-fnref-kernel-user-space","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"1"})}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["If the driver needs to access privileged functions, such as ",(0,i.jsx)(n.a,{href:"https://man7.org/linux/man-pages/man2/ioperm.2.html",children:(0,i.jsx)(n.code,{children:"ioperm()"})})," system calls to access x86 I/O ports, ",(0,i.jsx)(n.code,{children:"root"}),"-privileges are necessary."]}),"\n",(0,i.jsxs)(n.p,{children:["User Space Drivers offer a restricted alternative to ",(0,i.jsx)(n.strong,{children:"Kernel Space Drivers"}),". Their key advantage lies in improved system stability: If a bug slips into the User Space Driver, only the corresponding process is at risk of crashing, not the whole system."]}),"\n",(0,i.jsx)(n.h2,{id:"kernel-space-driver",children:"Kernel Space Driver"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Kernel Space Drivers"})," are embedded into the ",(0,i.jsx)(n.strong,{children:"kernel space"})," and provide full access to a device's memory and I/O ports. They can be statically linked into the kernel, requiring a full kernel compilation whenever the implementation of the driver changes. Errors in the driver itself will most likely negatively affect the stability of the whole system."]}),"\n",(0,i.jsxs)(n.p,{children:["As an alternative, ",(0,i.jsx)(n.strong,{children:"Loadable Kernel Modules"})," (",(0,i.jsx)(n.em,{children:"LKM"}),") allow drivers to be dynamically inserted into a running kernel without recompilation",(0,i.jsx)(n.sup,{children:(0,i.jsx)(n.a,{href:"#user-content-fn-lkm-wiki",id:"user-content-fnref-lkm-wiki","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"2"})}),". System directives such as ",(0,i.jsx)(n.a,{href:"#insmod--rmmod",children:(0,i.jsx)(n.code,{children:"insmod"})})," can be used for loading these modules."]}),"\n",(0,i.jsxs)(n.p,{children:["LKMs help reduce kernel size and compile times, accelerating development cycles (",(0,i.jsx)(n.code,{children:"load"})," ",(0,i.jsxs)(n.span,{className:"katex",children:[(0,i.jsx)(n.span,{className:"katex-mathml",children:(0,i.jsx)(n.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(n.semantics,{children:[(0,i.jsx)(n.mrow,{children:(0,i.jsx)(n.mo,{children:"\u2192"})}),(0,i.jsx)(n.annotation,{encoding:"application/x-tex",children:"\\rightarrow"})]})})}),(0,i.jsx)(n.span,{className:"katex-html","aria-hidden":"true",children:(0,i.jsxs)(n.span,{className:"base",children:[(0,i.jsx)(n.span,{className:"strut",style:{height:"0.3669em"}}),(0,i.jsx)(n.span,{className:"mrel",children:"\u2192"})]})})]})," ",(0,i.jsx)(n.code,{children:"test"})," ",(0,i.jsxs)(n.span,{className:"katex",children:[(0,i.jsx)(n.span,{className:"katex-mathml",children:(0,i.jsx)(n.math,{xmlns:"http://www.w3.org/1998/Math/MathML",children:(0,i.jsxs)(n.semantics,{children:[(0,i.jsx)(n.mrow,{children:(0,i.jsx)(n.mo,{children:"\u2192"})}),(0,i.jsx)(n.annotation,{encoding:"application/x-tex",children:"\\rightarrow"})]})})}),(0,i.jsx)(n.span,{className:"katex-html","aria-hidden":"true",children:(0,i.jsxs)(n.span,{className:"base",children:[(0,i.jsx)(n.span,{className:"strut",style:{height:"0.3669em"}}),(0,i.jsx)(n.span,{className:"mrel",children:"\u2192"})]})})]})," ",(0,i.jsx)(n.code,{children:"unload"}),").\nHowever, they might introduce a slight performance overhead due to the additional abstraction layer between the module and the kernel."]}),"\n",(0,i.jsxs)(n.h3,{id:"insmod--rmmod",children:[(0,i.jsx)(n.code,{children:"insmod"})," / ",(0,i.jsx)(n.code,{children:"rmmod"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://man7.org/linux/man-pages/man8/insmod.8.html",children:(0,i.jsx)(n.code,{children:"insmod"})})," is used for ",(0,i.jsx)(n.strong,{children:"loading"})," an LKM into the kernel."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://man7.org/linux/man-pages/man8/rmmod.8.html",children:(0,i.jsx)(n.code,{children:"rmmod"})})," is used for ",(0,i.jsx)(n.strong,{children:"unloading"})," an LKM",(0,i.jsx)(n.sup,{children:(0,i.jsx)(n.a,{href:"#user-content-fn-modprobe",id:"user-content-fnref-modprobe","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"3"})}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The following excerpt from a bash script demonstrates the usage of ",(0,i.jsx)(n.code,{children:"insmod"})," / ",(0,i.jsx)(n.code,{children:"rmmod"}),": The call to ",(0,i.jsx)(n.code,{children:"rmmod"}),"\nremoves the specific module if it was already loaded",(0,i.jsx)(n.sup,{children:(0,i.jsx)(n.a,{href:"#user-content-fn-devnull",id:"user-content-fnref-devnull","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"4"})}),", ",(0,i.jsx)(n.code,{children:"insmod"})," loads it accordingly."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'#! /bin/bash\n\nsudo rmmod ${MODULE} 2>/dev/null\n\n# loads the module\nsudo insmod ${MODULE}.ko || { echo "Error loading ${MODULE}.ko"; exit 1; }\n'})}),"\n",(0,i.jsxs)(n.h3,{id:"init_module--cleanup_module",children:[(0,i.jsx)(n.code,{children:"init_module"})," / ",(0,i.jsx)(n.code,{children:"cleanup_module"})]}),"\n",(0,i.jsxs)(n.p,{children:["Additionally, there exist two functions in the Linux-Kernel library ",(0,i.jsx)(n.a,{href:"https://github.com/torvalds/linux/blob/master/include/linux/module.h",children:(0,i.jsx)(n.code,{children:"<linux/module.h>"})})," that can be used as callbacks when the LKM has been loaded / unloaded for further bootstrapping module functionality, requesting system resources and freeing them, respectively:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"init_module"}),": Called when the module is initialized (",(0,i.jsx)(n.code,{children:"insmod"}),")"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"cleanup_module"}),": Called when the module is unloaded (",(0,i.jsx)(n.code,{children:"rmmod"}),")"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The following listing",(0,i.jsx)(n.sup,{children:(0,i.jsx)(n.a,{href:"#user-content-fn-clanguage",id:"user-content-fnref-clanguage","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"5"})})," shows the usage of ",(0,i.jsx)(n.code,{children:"init_module()"})," and ",(0,i.jsx)(n.code,{children:"cleanup_module()"}),". Take note that"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"device_major"})," specifies the major device number",(0,i.jsx)(n.sup,{children:(0,i.jsx)(n.a,{href:"#user-content-fn-identity",id:"user-content-fnref-identity","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"6"})})," associated with the device implemented by the module. We set this to ",(0,i.jsx)(n.code,{children:"0"})," and expect the kernel to dynamically allocate a device identifier."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.a,{href:"https://github.com/torvalds/linux/blob/master/include/linux/fs.h",children:[(0,i.jsx)(n.code,{children:"register_chrdev"})," / ",(0,i.jsx)(n.code,{children:"unregister_chrdev"})]})," takes care of (un)registering the module with the kernel: ",(0,i.jsx)(n.code,{children:"register_chrdev"})," provides information to the kernel which file-operations are mapped to which functions in the specific module. ",(0,i.jsx)(n.code,{children:"unregister_chrdev"})," de-registers this information accordingly."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-c",children:'#include <linux/module.h>\n#include <linux/fs.h>\n...\n\n#define MODULE_NAME "myModule"\n\nstatic int device_major = 0;\n\nstruct file_operations module_fops = {\n    .owner = THIS_MODULE,\n    // ...\n};\n\n\nint init_module(void) {\n    \n    printk(KERN_INFO "%s init start:\\n", MODULE_NAME);\n    int result = register_chrdev(device_major, MODULE_NAME, &module_fops);\n\n    if (result < 0) {\n        printk(KERN_ERR " Failed to register %s: Error %d\\n", MODULE_NAME, result);\n        return result;\n    }\n    \n    if (device_major == 0) {\n        device_major = result;\n    }\n    ... \n    \n    return 0;\n}\n\n\nvoid cleanup_module(void) {\n    printk(KERN_INFO "%s cleanup start:\\n", MODULE_NAME);\n    unregister_chrdev(device_major, MODULE_NAME);\n    \n    ...\n    \n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n","\n",(0,i.jsxs)(n.section,{"data-footnotes":!0,className:"footnotes",children:[(0,i.jsx)(n.h2,{className:"sr-only",id:"footnote-label",children:"Footnotes"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{id:"user-content-fn-kernel-user-space",children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://www.kernel.org/doc/html/latest/driver-api/uio-howto.html",children:"https://www.kernel.org/doc/html/latest/driver-api/uio-howto.html"}),", retrieved 01.05.2025 ",(0,i.jsx)(n.a,{href:"#user-content-fnref-kernel-user-space","data-footnote-backref":"","aria-label":"Back to reference 1",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{id:"user-content-fn-lkm-wiki",children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Loadable_kernel_module",children:"https://en.wikipedia.org/wiki/Loadable_kernel_module"}),", retrieved 01.05.2025 ",(0,i.jsx)(n.a,{href:"#user-content-fnref-lkm-wiki","data-footnote-backref":"","aria-label":"Back to reference 2",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{id:"user-content-fn-modprobe",children:["\n",(0,i.jsxs)(n.p,{children:["The man-pages specifically point to ",(0,i.jsx)(n.a,{href:"https://man7.org/linux/man-pages/man8/modprobe.8.html",children:(0,i.jsx)(n.code,{children:"modprobe"})})," which takes care of unloading interdependent modules ",(0,i.jsx)(n.a,{href:"#user-content-fnref-modprobe","data-footnote-backref":"","aria-label":"Back to reference 3",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{id:"user-content-fn-devnull",children:["\n",(0,i.jsxs)(n.p,{children:["while ignoring possible error messages like ",(0,i.jsx)(n.code,{children:"rmmod: ERROR: Module is not currently loaded"})," ",(0,i.jsx)(n.a,{href:"#user-content-fnref-devnull","data-footnote-backref":"","aria-label":"Back to reference 4",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{id:"user-content-fn-clanguage",children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"static int device_major"})," takes care of limiting the scope of ",(0,i.jsx)(n.code,{children:"device_major"})," to the compilation unit (",(0,i.jsx)(o.R5,{pp:"83",name:"KR88"}),") ",(0,i.jsx)(n.a,{href:"#user-content-fnref-clanguage","data-footnote-backref":"","aria-label":"Back to reference 5",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{id:"user-content-fn-identity",children:["\n",(0,i.jsxs)(n.p,{children:["'Device nodes and major/minor numbers': ",(0,i.jsx)(n.a,{href:"https://www.ibm.com/docs/en/linux-on-systems?topic=hdaa-device-nodes-numbers",children:"https://www.ibm.com/docs/en/linux-on-systems?topic=hdaa-device-nodes-numbers"}),", retrieved 02.05.2025 ",(0,i.jsx)(n.a,{href:"#user-content-fnref-identity","data-footnote-backref":"","aria-label":"Back to reference 6",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(m,{...e})}):m(e)}},3271:(e,n,r)=>{r.d(n,{R5:()=>i,I8:()=>i,Dn:()=>t,lA:()=>o,E4:()=>i,$1:()=>o});r(6540);var s=r(4848);function i(e){let{name:n,pp:r,add:i}=e;const t=`#bibref-${n.toLowerCase()}`;return(0,s.jsxs)("a",{href:t,children:["[",(0,s.jsxs)("span",{className:"bibRef",children:["\ud83d\udcd6",n]}),i?`, ${i} `:"",r?`, ${r.includes("-")?"pp":"p"}. ${r}`:"","]"]})}function t(e){let{idx:n}=e;return(0,s.jsx)("a",{href:`#fig_${n}`,children:(0,s.jsxs)("span",{className:"bibRef",children:["Figure ",n]})})}function o(e){let{name:n,file:r,url:i}=e;r=r||(i||""),Object.entries({sd:"softwaredesign",sa:"softwarearchitecture",cs:"computerscience"}).some((e=>{let[n,s]=e;if(r.startsWith(`${n}.`))return r=r.replace(`${n}.`,`${s}.`),!0}));const t=`/docs/wiki/${r}`;return(0,s.jsx)("a",{href:t,className:"glosRef",children:n})}},5142:(e,n,r)=>{r.d(n,{o:()=>i});r(6540);var s=r(4848);function i(){return(0,s.jsx)("div",{style:{width:"100%",textAlign:"right"},children:(0,s.jsx)("a",{style:{textDecoration:"underline"},onClick:()=>history.go(-1),href:"#",children:"Back"})})}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>l});var s=r(6540);const i={},t=s.createContext(i);function o(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);