(self.webpackChunkthorsten_suckow_homberg_de=self.webpackChunkthorsten_suckow_homberg_de||[]).push([[8098],{3905:(e,t,n)=>{"use strict";n.d(t,{Zo:()=>p,kt:()=>u});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),h=r,u=d["".concat(l,".").concat(h)]||d[h]||m[h]||o;return n?a.createElement(u,i(i({ref:t},p),{},{components:n})):a.createElement(u,i({ref:t},p))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},2490:(e,t,n)=>{"use strict";n.d(t,{$o:()=>p,_b:()=>m,cx:()=>c,e2:()=>d,in:()=>u,t2:()=>h});var a=n(7294),r=n(5075),o=n(9943),i=n(814),s=n(4098),l=n.n(s);function c(e){let{width:t,children:n,title:o,figure:i,modeAware:s}=e;return a.createElement("div",{style:{width:t,textAlign:"center",margin:20}},a.createElement("div",{className:!1!==s?"umlImg":""},n),a.createElement("div",{style:{textAlign:"center"}},a.createElement("sup",null,a.createElement("b",null,r.Z.isString(i)?i:`Figure ${i??1}`)," ",a.createElement("span",{dangerouslySetInnerHTML:{__html:o}}))))}function p(e){let{id:t,source:n,title:r}=e;return a.createElement(c,{modeAware:!1,title:r,figure:`Source ${n}`},a.createElement(o.Z,{id:t}))}function d(e){let{url:t,figure:n,title:r}=e;return a.createElement(c,{modeAware:!1,figure:n,title:r},a.createElement("img",{alt:"{title}",src:t}))}function m(e){let{children:t,figure:n,title:r}=e;return a.createElement(c,{modeAware:!0,figure:n,title:r,children:t})}function h(e){let{when:t,where:n}=e;const[r,o]=n;return a.createElement("div",null,"This article was originally published in ",t," at ",a.createElement("a",{target:"_blank",href:o},r),". Some formatting might have get lost during the migration to this site: If you think you spotted an issue caused by malformed formatting, feel free to open a ",a.createElement("a",{href:"https://github.com/ThorstenSuckow/thorsten.suckow-homberg.de"},"Pull Request")," or ",a.createElement("a",{href:"mailto:thorsten@suckow-homberg.de"},"send me an Email"),".")}function u(e){let{url:t}=e;const[n,r]=a.useState("");return l()(t).then((e=>{e.text().then((e=>r(e)))})),a.createElement(i.Z,{language:"php"},n)}},6739:(e,t,n)=>{"use strict";n.d(t,{A:()=>o,E:()=>r});var a=n(7294);function r(e){let{name:t,pp:n}=e;const r=`/docs/bibliography#${t.toLowerCase()}`;return a.createElement("a",{href:r},"[",a.createElement("span",{className:"bibRef"},"\ud83d\udcd6",t),n?`, ${n.includes("-")?"pp":"p"}. ${n}`:"","]")}function o(e){let{name:t,file:n}=e;Object.entries({sd:"softwaredesign",sa:"softwarearchitecture",cs:"computerscience"}).some((e=>{let[t,a]=e;if(n.startsWith(`${t}.`))return n=n.replace(`${t}.`,`${a}.`),!0}));const r=`/docs/toolbox/${n}`;return a.createElement("a",{href:r,className:"glosRef"},t)}},659:(e,t,n)=>{"use strict";n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>c,toc:()=>d});var a=n(7462),r=(n(7294),n(3905)),o=n(2490),i=n(6739);const s={title:"Dependency Injection in JavaScript"},l=void 0,c={unversionedId:"articles/dependency-injection-in-javascript/index",id:"articles/dependency-injection-in-javascript/index",title:"Dependency Injection in JavaScript",description:"Implementing Constructor Injection with the help of JavaScript Proxies.",source:"@site/docs/articles/dependency-injection-in-javascript/index.mdx",sourceDirName:"articles/dependency-injection-in-javascript",slug:"/articles/dependency-injection-in-javascript/",permalink:"/docs/articles/dependency-injection-in-javascript/",draft:!1,editUrl:"https://github.com/thorstensuckow/thorsten.suckow-homberg.de/tree/main/docs/articles/dependency-injection-in-javascript/index.mdx",tags:[],version:"current",lastUpdatedBy:"Thorsten Suckow-Homberg",lastUpdatedAt:1706997528,formattedLastUpdatedAt:"Feb 3, 2024",frontMatter:{title:"Dependency Injection in JavaScript"},sidebar:"docs",previous:{title:"Use Case 1 - Adding a new employee",permalink:"/docs/articles/agp-the-payroll-system/Use-Case-1-Adding-a-new-employee"},next:{title:"Ext JS - Beyond ES5",permalink:"/docs/articles/sencha-extjs-beyond-es5/"}},p={},d=[{value:"Motivation",id:"motivation",level:2},{value:"How it works",id:"how-it-works",level:2},{value:"Metadata: Static builds vs. runtime configuration",id:"metadata-static-builds-vs-runtime-configuration",level:3},{value:"Creating the Bindings",id:"creating-the-bindings",level:2},{value:"Finding a common language",id:"finding-a-common-language",level:3},{value:"Use Case: Injecting Authentication Methods",id:"use-case-injecting-authentication-methods",level:3},{value:"Bindings explained",id:"bindings-explained",level:3},{value:"Resolving dependencies \u2014 trapping the Factories",id:"resolving-dependencies--trapping-the-factories",level:2},{value:"Proxying the constructors",id:"proxying-the-constructors",level:2},{value:"Dependency Injection in Angular",id:"dependency-injection-in-angular",level:2},{value:"Additional Resources",id:"additional-resources",level:2}],m={toc:d},h="wrapper";function u(e){let{components:t,...n}=e;return(0,r.kt)(h,(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Implementing Constructor Injection with the help of JavaScript Proxies."),"\n",(0,r.kt)("em",{parentName:"p"},"Remove hardcoded dependencies in Code and provide interchangeable strategies for algorithms by injecting dependencies using an Inversion of Control-Container.")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)(o.t2,{when:"December 2022",where:["medium.com","https://medium.com/@thorstensuckow/dependency-injection-in-javascript-7f85dae43121"],mdxType:"MigrationNotice"})),(0,r.kt)("h2",{id:"motivation"},"Motivation"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Low coupling")," and ",(0,r.kt)("em",{parentName:"p"},"high cohesion")," does not imply the total absence of associations: The usage of abstraction layers rightfully demands specifics that provide concrete implementations satisfying contracts between parts of a system. After all, a program doesn\u2019t work if there is nothing that conforms to its ",(0,r.kt)("em",{parentName:"p"},"Interfaces")," and ",(0,r.kt)("em",{parentName:"p"},"Abstract Classes"),"."),(0,r.kt)(o.e2,{url:"https://cdn-images-1.medium.com/max/2000/1*uKWFPsl49H9ZNyJaEzsrwA.png",figure:1,title:"The most basic expectation regarding a computer program is that a given input produces some output.",mdxType:"ImgEmbed"}),(0,r.kt)("p",null,"However, the way these dependencies are wired throughout source code often comes with a bitter taste: Dependencies are found in convoluted and deeply nested program code, effectively violating ",(0,r.kt)(i.A,{name:"SRP",file:"sd.singleresponsibilityprinciple",mdxType:"GlosRef"}),"  and ",(0,r.kt)(i.A,{name:"DIP",file:"sd.dependencyinversionprinciple",mdxType:"GlosRef"}),"."),(0,r.kt)("p",null,"We are in the need of tools and design patterns that can help us with detangling the code, or we will end up with a program that has intricate boilerplate code for setting up mocks and stubs for testing, or worse: Becomes a nightmare to integrate with different environments and infrastructures. Granted, languages like ",(0,r.kt)("em",{parentName:"p"},"JavaScript")," makes it easy to mock dependencies during tests, but other languages are not so forgiving and test cases tend to get more complicated the more dependencies are hardwired."),(0,r.kt)("p",null,"The following source code was taken from a ",(0,r.kt)("em",{parentName:"p"},"REPOSITORY"),"-implementation that uses a concrete Storage-class that hides away infrastructure that is used for writing data:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'    class DataRepository {\n\n        async storeData(data) {\n             const  {Storage} = await import("storageApi");\n\n             const store = new Storage(...);\n\n             store.save(data);\n        }\n\n    }\n')),(0,r.kt)("p",null,"It seems to align nicely with our code standards \u2014 it\u2019s small, it explains its intends clearly without additional comments, and it delegates to a sub-program responsible for communicating with infrastructure that is not of interest to us."),(0,r.kt)("p",null,"However, this method uses a hardwired dependency to storageApi which gets imported as a ",(0,r.kt)("em",{parentName:"p"},"module"),". Even more, everything the constructor of Storage requires has to be handled from inside the storeData()-method. For testing this code, the developer has to create a ",(0,r.kt)("em",{parentName:"p"},"Mock "),"not only for Storage, but also needs to stub the call to import. The ",(0,r.kt)("em",{parentName:"p"},"DataRepository")," directly accesses the low-level API from within its boundaries, which results in strong coupling between two different layers. This should not happen in the given storeData()-method, although the ",(0,r.kt)("em",{parentName:"p"},"DataRepository "),"obviously has to know that there must be some kind of infrastructure-layer."),(0,r.kt)(o.e2,{figure:2,title:"The \u201cDataRepository\u201d directly accessing \u201cStorage\u201d creates strong coupling between two concretes that should be unaware of each other.",url:"https://cdn-images-1.medium.com/max/2000/1*_WhWG5I4xXz4VNE1qGT4YA.png",mdxType:"ImgEmbed"}),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"}," ",(0,r.kt)("em",{parentName:"p"},"The Dependency Inversion Principle requires high-level modules to not import anything from low-level modules. This is one of the ",(0,r.kt)(i.A,{name:"SOLID",file:"sd.solid",mdxType:"GlosRef"})," design principles.")," ",(0,r.kt)(i.E,{name:"ASD",mdxType:"BibRef"}))),(0,r.kt)(o.e2,{figure:3,title:"The \u201cDataRepository\u201d is configured with the \u201cStorage\u201d-instance. Now, the repository can focus on using the Storage\u2019s public API and doesn\u2019t have to take care of importing and configuring it. In tests, the API of the \u201cStorage\u201d-instance can easily be mocked.",url:"https://cdn-images-1.medium.com/max/2000/1*DtDuuhsU0sCrZpiDas0fYg.png",mdxType:"ImgEmbed"}),(0,r.kt)("p",null,"This article introduces an ",(0,r.kt)("a",{parentName:"p",href:"https://martinfowler.com/articles/injection.html#ConstructorInjectionWithPicocontainer"},"Inversion of Control")," (",(0,r.kt)("em",{parentName:"p"},"IoC"),")-Container that decides ",(0,r.kt)("em",{parentName:"p"},"during runtime "),"if code has additional dependencies defined, and if any existing dependency should be resolved by the IoC-Container. This is realised through ",(0,r.kt)("em",{parentName:"p"},"bindings "),"configured by a client and passed to the the IoC-Container: These provide information for the ",(0,r.kt)("em",{parentName:"p"},"concrete "),"that has to be instantiated for a ",(0,r.kt)("em",{parentName:"p"},"type, "),"i.e. an ",(0,r.kt)("em",{parentName:"p"},"Interface, "),"or any ",(0,r.kt)("em",{parentName:"p"},"(Abstract) Class"),",* *required by an arbitrary host."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Bindings")," can be used and adjusted application-wide, but it\u2019s good practice to provide them during bootstrapping. This makes it easy to run programs with different implementations for selected clients, contexts or environments, and this all works without having to change a single line of low/high-level code at all."),(0,r.kt)(o.e2,{figure:4,title:"Our Proxy wraps the constructors of selected target classes and injects dependencies with arguments as needed.",url:"https://cdn-images-1.medium.com/max/2000/1*-a6VVDQmBS0RqfQcg5RI_g.png",mdxType:"ImgEmbed"}),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Proxies "),"help with the implementation of resolving objects and dependencies, and this approach is not exclusive to JavaScript: For example, ",(0,r.kt)("a",{parentName:"p",href:"https://docs.oracle.com/javase/10/docs/api/java/lang/reflect/Proxy.html"},"Java")," has Proxies, ",(0,r.kt)("a",{parentName:"p",href:"https://docs.spring.io/spring-framework/docs/3.2.x/spring-framework-reference/html/beans.html"},"Spring")," uses them for its IoC and ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Aspect-oriented_programming"},"AOP"),"."),(0,r.kt)("p",null,"If you need to catch up with the concept of Proxies and how they work in JavaScript, I recommend you read through ",(0,r.kt)("a",{parentName:"p",href:"/docs/articles/a-fluent-interface-for-javascript-promises/"},"this elaborate article")," that provides details on how to use Proxies with ",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise"},"*Promises"),"* to create ",(0,r.kt)("a",{parentName:"p",href:"https://martinfowler.com/bliki/FluentInterface.html"},"Fluent Interfaces"),"."),(0,r.kt)("p",null,"For the following examples, I will constantly refer to the IoC-Container implementation of ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/coon-js/extjs-lib-core/tree/main/src/ioc"},"coon.core.ioc"),": This is an implementation specific for the Sencha Ext JS framework, but it\u2019s concepts can easily be carried over to other frameworks or framework-agnostic code."),(0,r.kt)("h2",{id:"how-it-works"},"How it works"),(0,r.kt)("p",null,"Target classes need to provide information if they are ",(0,r.kt)("em",{parentName:"p"},"injectable"),", i.e. if they should be considered by the ",(0,r.kt)("em",{parentName:"p"},"IoC-Container")," during instantiation. This is needed because we want to auto-wire dependencies to keep our program as flexible as possible: The IoC-Container gets configured with bindings during the startup sequence, then takes care of publishing the configured types with their concrete implementations during the runtime of the application."),(0,r.kt)(o.e2,{figure:5,title:"The IoC-Container will take care of dynamically resolving dependencies for a concrete instance that is required by the client.",url:"https://cdn-images-1.medium.com/max/2072/1*Fp-tQqL8FkovoZCInq0jCw.png",mdxType:"ImgEmbed"}),(0,r.kt)("p",null,"Most programming languages and their platforms already provide the tools for handling additional information written with source code: ",(0,r.kt)("em",{parentName:"p"},"Metadata "),"is often created with the help of ",(0,r.kt)("a",{parentName:"p",href:"https://jcp.org/en/jsr/proposalDetails?id=175"},"annotations in Java"),", or ",(0,r.kt)("a",{parentName:"p",href:"https://www.php.net/manual/en/language.attributes.overview.php"},"Attributes in PHP8"),"."),(0,r.kt)("h3",{id:"metadata-static-builds-vs-runtime-configuration"},"Metadata: Static builds vs. runtime configuration"),(0,r.kt)("p",null,"With the almost incomprehensible amount of tooling options for JavaScript, using annotations would probably cost little effort; however, it would most certainly mean that the build stack of our project changes: An additional tool that has the implementation for parsing our source code also extracts and translates metadata and makes sure that the resulting build does not break during runtime."),(0,r.kt)("p",null,"An annotation in the form of"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"    /**\n     * @injectable store:Storage\n     */\n    class Repository {\n       // ...\n    }\n")),(0,r.kt)("p",null,"would be useful, and additional annotations can be defined in some sort of dictionary."),(0,r.kt)("p",null,"The parser could then build configuration files out of the metadata found in the sources, connect them with the names of the target classes (and the paths to the imports), along with the properties (i.e. names of the instance variables of the target classes) which expect a particular type, and then plug it all together by applying the bindings configured by the developers and stored in the IoC-Container."),(0,r.kt)(o.e2,{figure:6,title:"Using annotations with JavaScript code would require a separate build step in the ci/cd pipeline.",url:"https://cdn-images-1.medium.com/max/2000/1*6vbAE-JdDqXnQ-4swvadLw.png",mdxType:"ImgEmbed"}),(0,r.kt)("p",null,"We strive for an implementation that does not need such additional tooling: We will provide the ",(0,r.kt)("strong",{parentName:"p"},"metadata "),"as **static class members on top of the injectable classes."),(0,r.kt)("p",null,"The following source code demonstrates the use of the ",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes/static?retiredLocale=de"},"static-property"),": A property named required is the root for the ",(0,r.kt)("em",{parentName:"p"},"meta information "),"looked up by the IoC-Container and its ",(0,r.kt)("em",{parentName:"p"},"Dependency Resolver"),": It holds all the names of the instance variables that expect specifics of a given type: In the example, an instance of Repository only works with a store-member that holds a reference to an instance of Storage."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'    class Repository {\n        static required = {\n            store: "Storage"\n        }\n\n       //...\n    }\n')),(0,r.kt)("p",null,"With the help of the ",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy"},(0,r.kt)("strong",{parentName:"a"},"Proxy"),"-Api"),", we can then ",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/construct"},"add a trap for the calls to the constructor")," of the ",(0,r.kt)("em",{parentName:"p"},"injectable")," classes, in this case the Repository-class:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'    class Repository {\n       static required = {\n           store: "Storage"\n       };\n\n       constructor({store}) {\n           this.store = store;\n       }\n\n       //...\n    }\n\n\n    const constructorHandler = {\n\n        construct (target, argumentsList, newTarget) {\n            if (target.required) {\n                // container holds a reference to the ioc-container\n                container.inject(argumentsList, target.require);\n            }\n\n            return new target(...argumentsList);\n        }\n\n    };\n\n\n    Repository = new Proxy(Repository, constructorHandler)\n')),(0,r.kt)("p",null,"The handler will delegate to the IoC-Container before the instance of the target class is created: The IoC-Container then inspects the argument-list and looks for any missing properties in a previously contracted argument-object that\u2019s used to configure the instance. Denoted by the required-property, the instance variable\u2019s name must be the same as the configuration object containing the property needed by the constructor:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'    // IoC-container will not inject anything, since the instance gets configured\n    // with a "store"-property\n    new Repository({store: new Storage(), uri: "/resourceUri"});\n\n\n    // since the "store"-property is missing, the IoC-container will\n    // inject a concrete of "Storage" according to the available bindings\n    new Repository({uri: "/resourceUri"});\n')),(0,r.kt)("h2",{id:"creating-the-bindings"},"Creating the Bindings"),(0,r.kt)("p",null,"Bindings are the Point of Truth for our application since we rely on builders and resolvers that are configured upfront and take care of assembling associations during runtime. ",(0,r.kt)("em",{parentName:"p"},"Bindings")," map concrete ",(0,r.kt)("em",{parentName:"p"},"Sub Types")," to ",(0,r.kt)("em",{parentName:"p"},"Types, "),"means: They \u201cbind\u201d a ",(0,r.kt)("em",{parentName:"p"},"typed")," variable to the specific implementation of the ",(0,r.kt)("em",{parentName:"p"},"Type"),", so our IoC-Container knows ",(0,r.kt)("em",{parentName:"p"},"what")," to apply and ",(0,r.kt)("em",{parentName:"p"},"where")," to apply it (the ",(0,r.kt)("em",{parentName:"p"},"when "),"is implied by the usage of a ",(0,r.kt)("em",{parentName:"p"},"Constructor Injector"),"). The requested ",(0,r.kt)("em",{parentName:"p"},"specific")," implements an interface or extends an (abstract) class and the ",(0,r.kt)(i.A,{name:"LSP",file:"sd.liskovsubstitutionprinciple",mdxType:"GlosRef"})," gives us the freedom to provide arbitrary implementations of this given ",(0,r.kt)("em",{parentName:"p"},"Type"),"."),(0,r.kt)("p",null,"Since we are loosely typed, our ",(0,r.kt)("em",{parentName:"p"},"Dependency Resolver")," (think of it as sort of a ",(0,r.kt)("em",{parentName:"p"},"Builder, "),") must and will make sure that our specifics are indeed instances of the required type."),(0,r.kt)("h3",{id:"finding-a-common-language"},"Finding a common language"),(0,r.kt)("p",null,"We will introduce a model language that will help us with formulating the bindings needed throughout our program."),(0,r.kt)("p",null,"We have a class ",(0,r.kt)("strong",{parentName:"p"},"A")," that uses an instance of a class ",(0,r.kt)("strong",{parentName:"p"},"B"),":"),(0,r.kt)(o.e2,{figure:7,title:"A needs B.",url:"https://cdn-images-1.medium.com/max/2000/1*g1Xsof_xlXjjIEcZ5q1WZQ.png",mdxType:"ImgEmbed"}),(0,r.kt)("p",null,"The code for"),(0,r.kt)("p",null,"\u201c",(0,r.kt)("strong",{parentName:"p"},"A")," has a dependency to Type ",(0,r.kt)("strong",{parentName:"p"},"B"),", and this dependency is reflected in ",(0,r.kt)("strong",{parentName:"p"},"A"),"\u2019s instance variable ",(0,r.kt)("strong",{parentName:"p"},"b"),"\u201d"),(0,r.kt)("p",null,"could look like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    // Pseudo code\n\n    abstract class B {\n        abstract calculate();\n    }\n\n\n    class A {\n\n        constructor (B b)\n        {\n          this.b = b;\n        }\n\n\n        calculation()\n        {\n            this.b.calculate();\n        }\n    }\n")),(0,r.kt)("p",null,"Obviously, sources that rely on ",(0,r.kt)("strong",{parentName:"p"},"A")," will not work without an ",(0,r.kt)("strong",{parentName:"p"},"[instanceof A]",".b")," \u2014 as soon as calculation() delegates to b.calculate()and ",(0,r.kt)("strong",{parentName:"p"},"b")," is undefined, an exception will be thrown."),(0,r.kt)("p",null,"We are looking for a formal (yet simple) definition that can be used with JavaScript to configure these dependencies: We\u2019ll agree on JSON as the format, since it allows for key/value-pairs whereas the keys are of type string and their values can be any of string, integer, boolean, NULL, object and array \u2014 we\u2019ll make use of string and object."),(0,r.kt)("p",null,"Let\u2019s refine the task for resolving the dependencies of ",(0,r.kt)("strong",{parentName:"p"},"A"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    **when** A\n      **requires** B\n      **give** *new instance* of B\n")),(0,r.kt)("p",null,"That\u2019s a rather simple term which will be translated later into an assignment by the ",(0,r.kt)("em",{parentName:"p"},"Dependency Resolver"),". For now, this is how it\u2019s transposed to JSON (don\u2019t mind the explanatory comments):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'     {\n        /* when */\n        "A": {\n          /* "needs": "give" */\n          "B" : "InstanceOfB"\n        }\n    }\n')),(0,r.kt)("h3",{id:"use-case-injecting-authentication-methods"},"Use Case: Injecting Authentication Methods"),(0,r.kt)("p",null,"With coon.core.ioc as part of a coon.js-application, here\u2019s a typical call to coon.core.ioc.Container.bind():"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'    // Some class names have been shortened in favor of\n    // readability.\n    coon.core.ioc.Container.bind({\n            "conjoon.dev.cn_mailsim": {\n                "conjoon.SimletAdapter": "conjoon.BasicAuthSimletAdapter"\n            },\n            "conjoon.cn_mail": {\n                "coon.core.data.request.Configurator": {\n                    "$ref": "#/$defs/RequestConfiguratorSingleton"\n                }\n            },\n            "$defs": {\n                "RequestConfiguratorSingleton": {\n                    "xclass": "conjoon.cn_imapuser.data.request.Configurator",\n                    "singleton": true\n                }\n            }\n\n    });\n')),(0,r.kt)("p",null,"This configuration represents bindings of the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/conjoon/extjs-app-imapuser"},"extjs-app-imapuser"),"-package, an npm package providing user authentication for ",(0,r.kt)("a",{parentName:"p",href:"https://www.conjoon.org/"},"conjoon\u2019s")," ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/conjoon/extjs-app-webmail"},"extjs-app-webmail"),", which is an email client written in JavaScript."),(0,r.kt)(o.e2,{title:"The Login-Screen for the JavaScript webmail client used in conjoon, depending on the authentication module configured with this instance.",url:"https://cdn-images-1.medium.com/max/2634/1*OQUlvC7__3fRJwEaY90G7w.png",mdxType:"ImgEmbed"}),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"extjs-app-webmail")," communicates with a backend that is agnostic of the authentication being used \u2014 its architecture allows for guarding the endpoints with arbitrary authentication methods: It could be ",(0,r.kt)("em",{parentName:"p"},"Basic")," access authentication, or the API could use a guard that relies on token based authentication. That is why the requesting client \u2014 in this case ",(0,r.kt)("strong",{parentName:"p"},"extjs-app-webmail")," \u2014 needs to be configured with the proper security technique the backend understands. This is done by using ",(0,r.kt)("em",{parentName:"p"},"Request Configurators")," that hook into (some/all/none at all) outgoing requests and add the authentication information if required by the backend, e.g. a Authorization-header field, holding Bearer- ,Basic- or other information."),(0,r.kt)("h3",{id:"bindings-explained"},"Bindings explained"),(0,r.kt)("p",null,"Let\u2019s have a detailed look at the given binding configuration. First of, the bindings configured here are introduced with namespaces instead of class names. This is just another way of defining bindings for a ",(0,r.kt)("strong",{parentName:"p"},"set")," of classes owned by a namespace (i.e. a whole ",(0,r.kt)("em",{parentName:"p"},"module"),"): Instead of individually defining dependencies for"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"conjoon.dev.cn_mailsim.A, conjoon.dev.cn_mailsim.B, conjoon.dev.cn_mailsim.C, \u2026\n")),(0,r.kt)("p",null,"we fall back to their common namespace, so the ",(0,r.kt)("em",{parentName:"p"},"Dependency Resolver")," can look up bindings configured for this module when a target class is not explicitly specified in the configuration. Target classes are always given precedence, then namespaces are queried."),(0,r.kt)("p",null,"The same goes for the following section, albeit the value of the ",(0,r.kt)("em",{parentName:"p"},"give"),"- implication is not the name of a class: It\u2019s a configuration that ",(0,r.kt)("em",{parentName:"p"},"references")," another ",(0,r.kt)("em",{parentName:"p"},"section"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'      "conjoon.cn_mail": {\n          "coon.core.data.request.Configurator": {\n             "$ref": "#/$defs/RequestConfiguratorSingleton"\n         }\n      }\n')),(0,r.kt)("p",null,"Based on the ",(0,r.kt)("a",{parentName:"p",href:"https://json-schema.org/draft/2020-12/json-schema-core.html#name-schema-references"},"JSON-schema specification"),", $ref uses an ",(0,r.kt)("em",{parentName:"p"},"URI")," to reference another section of the document it\u2019s embedded in, which allows for defining a reusable, complex configuration at one place, then re-use this configuration throughout the document by referencing it."),(0,r.kt)("p",null,"The (resolved)$ref in the above example states that"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"    when any class of conjoon.cn_mail\n      requires coon.core.data.request.Configurator\n      give Singleton of conjoon.cn_imapuser.data.request.Configurator\n")),(0,r.kt)("p",null,"Singletons are great when stateless objects are needed, and reduce the memory footprint in a target application."),(0,r.kt)("h2",{id:"resolving-dependencies--trapping-the-factories"},"Resolving dependencies \u2014 trapping the Factories"),(0,r.kt)("p",null,"The class-system of Sencha Ext JS makes \u2014 almost exclusively \u2014 use of Factories when instances are created. This is useful for dynamically loading classes: Its ",(0,r.kt)("em",{parentName:"p"},"microloader")," will take care of mapping class-names to the existing directory-structure of a project, but loading happens synchronously (in the worst case, if a class was not pre-loaded). Using Sencha Ext JS without it\u2019s own class system is almost impossible. In some cases, this is an unpleasant surprise for users starting with Ext JS in 2022."),(0,r.kt)(o.e2,{figure:8,title:"Sencha Ext JS Factory methods take care of resolving dependencies and instantiating objects.",url:"https://cdn-images-1.medium.com/max/2212/1*3b_FAuDIUOwN6Q97LzIWBw.png",mdxType:"ImgEmbed"}),(0,r.kt)("p",null,"However, the use of factories and factory methods throughout the framework makes it really easy to apply Proxies to them and plays into our hands with our constructor injection approach. Carefully selecting constructors of injectable target classes becomes obsolete and we can rely on the interiors of the framework when we have to decide if dependencies need to be injected."),(0,r.kt)("p",null,"A ",(0,r.kt)("em",{parentName:"p"},"Wrapper"),"-Proxy is installed as soon as coon.core.ioc.Container.bind() is called:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'     installProxies () {\n            const me = this;\n\n            Ext.Factory = new Proxy(\n                Ext.Factory,\n                Ext.create("coon.core.ioc.sencha.resolver.FactoryHandler")\n            );\n\n            Ext.create = new Proxy(\n                Ext.create,\n                Ext.create("coon.core.ioc.sencha.resolver.CreateHandler")\n            );\n        },\n')),(0,r.kt)("p",null,"There are two Proxy-Handlers that serve two different purposes. Let\u2019s have a look at them:"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Handler for Ext.create")),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"CreateHandler")," is a method that traps calls to Ext.create. It checks if the argument passed to Ext.create() is"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"a ",(0,r.kt)("em",{parentName:"p"},"String"),": If that is the case, it\u2019s assumed to be the name of the class an instance should be created for")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"an ",(0,r.kt)("em",{parentName:"p"},"Object"),": This generally indicates that the client submits a configuration, holding an xtype or xclass providing further details on the class that serves as the template. All the properties the object contains are usually passed to the constructor of the target class, except for xtype/ xclass"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'{\n"xtype": "alias-of-class",\n// or "xclass": "fqn.of.class"\n"cArg1": "foo",\n"cArg2": "bar"\n}\n')),(0,r.kt)("p",null,"As ",(0,r.kt)("strong",{parentName:"p"},"Figure 9 "),"shows, once the target class was successfully resolved given the internals of Ext JS, the handler fires the classresolved-event, along with information about the class name and the JavaScript ",(0,r.kt)("em",{parentName:"p"},"prototype")," of the resolved class."),(0,r.kt)(o.e2,{figure:9,title:"The Handler installed for Ext.create fires an event as soon as a class was successfully resolved.",url:"https://cdn-images-1.medium.com/max/2460/1*xXGjuVpZtsf6QmLiivrC7A.png",mdxType:"ImgEmbed"}),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Handler for Ext.Factory")),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"FactoryHandler")," implements traps for properties requested by a client (using ",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy/get"},"get"),") and a trap for any method that could possibly be a ",(0,r.kt)("em",{parentName:"p"},"factory method"),"."),(0,r.kt)("p",null,'Factory methods are based on types that get published with class definitions. Aliases are constantly used throughout Sencha Ext JS and facilitate lazy instantiation. Those aliases are using prefixes which represent the domain they serve, for example, aliases for Ext.data.Store have the prefix "store.\u201d, Ext.app.Controller use the prefix "controller.\u201d ',(0,r.kt)("a",{parentName:"p",href:"https://docs.sencha.com/extjs/7.6.0/classic/Ext.Class.html#cfg-alias"},"and so on"),"."),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"Ext.Factory")," wires these configurations through to the corresponding ",(0,r.kt)("em",{parentName:"p"},"factory methods"),", and that\u2019s where the apply-handler previously installed by the get-handler comes into play: It works just like the ",(0,r.kt)("strong",{parentName:"p"},"CreateHandler")," and differs only in subtle details when arguments to the factory methods are scrutinized. In the end, this proxy will trigger the classresolved-event for the same reason as its complement."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'    if (cls) {\n        const className = Ext.ClassManager.getName(cls);\n        me.fireEvent("classresolved", me, className, cls);\n    }\n')),(0,r.kt)("h2",{id:"proxying-the-constructors"},"Proxying the constructors"),(0,r.kt)("p",null,"It all boils down to the ",(0,r.kt)("strong",{parentName:"p"},"ConstructorInjector"),": Once the classresolved-event is published, the ",(0,r.kt)("strong",{parentName:"p"},"ConstructorInjector")," is used with an observer to decide whether it should inject dependencies into the target class\u2019 constructor (the information about the target class is exposed with the ",(0,r.kt)("em",{parentName:"p"},"event details"),"). It checks whether the class is ",(0,r.kt)("em",{parentName:"p"},"injectable "),"and if that\u2019s the case, it will apply a trap for the target class\u2019 constructor."),(0,r.kt)("p",null,"Think of the ",(0,r.kt)("em",{parentName:"p"},"Strategy Pattern")," here that allows us to dynamically change implementation details. It should be noted that the ",(0,r.kt)("strong",{parentName:"p"},"ConstructorInjector")," is working on ",(0,r.kt)("em",{parentName:"p"},"objects")," passed to the ",(0,r.kt)("em",{parentName:"p"},"constructor "),"as ",(0,r.kt)("em",{parentName:"p"},"arguments"),", rather than a list of arguments",(0,r.kt)("em",{parentName:"p"},". "),"So the ",(0,r.kt)("strong",{parentName:"p"},"ConstructorInjector")," is more of a ",(0,r.kt)("em",{parentName:"p"},"Property Injector"),". The name was chosen since",(0,r.kt)("strong",{parentName:"p"}," ConstructorInjector")," better reflects the step in the build chain the injector is woven into: The implementation for the Sencha Ext JS framework is kept simple and provides mainly (but not less than) qol-improvements for this framework."),(0,r.kt)("p",null,"The trap for the constructor will probe the target class for all the dependencies required (defined as ",(0,r.kt)("em",{parentName:"p"},"metainformation"),"), then use the ",(0,r.kt)("em",{parentName:"p"},"Dependency Resolver")," to create something useful out of the binding definition that was previously registered with coon.core.io.Container.bind()."),(0,r.kt)(o.e2,{figure:10,title:"When the client requests a new instance, the ConstructorInjector will make sure that dependencies required by the target instance are created and injected, if not already specified by the client.",url:"https://cdn-images-1.medium.com/max/2362/1*bKdGtQiwoy8a3W-a4cmDXQ.png",mdxType:"ImgEmbed"}),(0,r.kt)("h2",{id:"dependency-injection-in-angular"},"Dependency Injection in Angular"),(0,r.kt)("p",null,"In ",(0,r.kt)("a",{parentName:"p",href:"https://angular.io"},(0,r.kt)("strong",{parentName:"a"},"Angular")),", ",(0,r.kt)("strong",{parentName:"p"},"Dependency Injection")," is already built into the framework. Conversely to\nthe approach above where we set up the injectable classes in a global configuration file, ",(0,r.kt)("strong",{parentName:"p"},"Angular")," lets you decorate a\nclass as ",(0,r.kt)("strong",{parentName:"p"},"Injectable")," by using the ",(0,r.kt)("a",{parentName:"p",href:"https://angular.io/api/core/Injectable"},"@Injectable()"),"-Decorator:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="Image.service.ts [Angular]"',title:'"Image.service.ts','[Angular]"':!0},"@Injectable({\n  providedIn: 'root'\n})\nclass ImageService {}\n")),(0,r.kt)("p",null,"If we had such a class that provides an abstraction to an ",(0,r.kt)("inlineCode",{parentName:"p"},"ImageService"),", registering the service as an injectable ",(0,r.kt)(i.A,{name:"Singleton",file:"sd.singleton",mdxType:"GlosRef"})," in an ",(0,r.kt)("inlineCode",{parentName:"p"},"extjsapp")," namespaced ",(0,r.kt)("strong",{parentName:"p"},"Ext JS"),"-application\nwould translate to the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json",metastring:'"title=extjsapp.core.conf [Ext JS]"','"title':"extjsapp.core.conf","[Ext":!0,'JS]"':!0},'{\n     "ioc": {\n        "bindings": {\n            "extjsapp": {\n                "ImageService": {\n                    "xclass": "ImageService",\n                    "singleton": true\n                }\n            }\n        }\n    }\n}\n')),(0,r.kt)("p",null,"Constructor-binding works out-of the box with ",(0,r.kt)("strong",{parentName:"p"},"Angular"),". To register the ",(0,r.kt)("inlineCode",{parentName:"p"},"ImageService")," with a host, simply add the ",(0,r.kt)("inlineCode",{parentName:"p"},"ImageService")," as an argument for the host's constructor:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="Host.component.ts [Angular]"',title:'"Host.component.ts','[Angular]"':!0},'import {ImageService} from "./Image.service";\n\nclass HostComponent {\n    constructor (private imageService: ImageService) {}\n}\n')),(0,r.kt)("p",null,"whereas we'd have to denote the requirement in the ",(0,r.kt)("inlineCode",{parentName:"p"},"statics.required"),"-property to realize constructor injection:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript",metastring:'title="HostComponent.js [Ext JS]"',title:'"HostComponent.js',"[Ext":!0,'JS]"':!0},'Ext.define("HostComponent", {\n    statics: {\n        required: {\n            imageService: "ImageService"\n        }\n    },\n    // ....\n})\n\n')),(0,r.kt)("h2",{id:"additional-resources"},"Additional Resources"),(0,r.kt)("p",null,"The repository for coon.js and the IoC-Container implementation is located at ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/coon-js/extjs-lib-core"},"Github"),". It\u2019s already used in the newest version of ",(0,r.kt)("a",{parentName:"p",href:"https://www.conjoon.org/blog/2022/12/17/1.0.4-release"},"conjoon 1.0.4")," which is an interim release that paves the way for additional authentication plugins planned for ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/orgs/conjoon/projects/6"},"1.1.0"),"."),(0,r.kt)("hr",null),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Significant Revisions")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},'30 March 2023: Add section "Dependency Injection in Angular"')),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"05 March 2023: Merged article into this site")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"16 January 2023: Minor wording and content updates while working on the german translation")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"17 December 2022: Published first installment"))))}u.isMDXComponent=!0},2480:()=>{}}]);